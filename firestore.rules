rules_version = '2';

service cloud.firestore {
	match /databases/{database}/documents {
		// Only allow the two specific chat users
		function isAllowedUser() {
			return request.auth != null && (
				request.auth.uid == "DrTZw7Kv5MeGpdVbiU4lp6Kk6nF3" ||
				request.auth.uid == "EJTfm5BLcuQjgiCUMsYTVu0BJXS2"
			);
		}

		// Helper: ensure participants array contains exactly the 2 UIDs
		function validParticipants(p) {
			return p is list && p.size() == 2 &&
						 p.hasOnly(["DrTZw7Kv5MeGpdVbiU4lp6Kk6nF3", "EJTfm5BLcuQjgiCUMsYTVu0BJXS2"]);
		}

		// Helper: validate createdAt timestamps.
		// Accept either serverTimestamp() (which equals request.time) or a client timestamp
		// that is not in the future relative to request.time. This is more flexible
		// than requiring exact equality and avoids rejects when clients can't use
		// serverTimestamp().
		function isValidCreatedAt(ts) {
			return ts == request.time || (ts is timestamp && ts <= request.time);
		}

		// Conversation document
		match /conversations/{conversationId} {

			// Create conversation only once with correct participants
			allow create: if isAllowedUser() &&
							 validParticipants(request.resource.data.participants) &&
							 isValidCreatedAt(request.resource.data.createdAt);

			// Read conversation details
			allow read: if isAllowedUser();

			// Prevent updates/deletes to conversation doc
			allow update, delete: if false;

			// Messages subcollection
			match /messages/{messageId} {

				// Allow reading messages only for allowed users
				allow read: if isAllowedUser();

				// Allow sending a message (create only)
				// A message must be created by an allowed user, senderId must match auth.uid,
				// createdAt must be valid (serverTimestamp() or client time not in the future),
				// and either `text` (string) OR `media_url` (string) must be provided.
				// Receiver must be one of the participants.
				allow create: if isAllowedUser() &&
								 request.resource.data.senderId == request.auth.uid &&
								 isValidCreatedAt(request.resource.data.createdAt) &&
											 (
												 (request.resource.data.text is string && !(request.resource.data.media_url is string)) ||
												 (request.resource.data.media_url is string && !(request.resource.data.text is string))
											 ) &&
											 // ensure receiverId exists and is one of the participants
											 request.resource.data.receiverId is string &&
											 request.resource.data.receiverId in request.resource.data.participants;

				// Block edits or deletes completely
				allow update, delete: if false;
			}
		}

		// Optional: per-user profile documents to manage display name and avatar URL.
		// Path: /users/{userId}
		match /users/{userId} {
			// Allow anyone authenticated to read user profiles
			allow read: if request.auth != null;

			// Allow creating a user doc only if it's the authenticated user
			allow create: if request.auth != null && request.auth.uid == userId &&
										request.resource.data.name is string &&
										(request.resource.data.profileImageUrl is string || !('profileImageUrl' in request.resource.data));

			// Allow the authenticated user to update their own profile (name/profileImageUrl) but nothing else
			allow update: if request.auth != null && request.auth.uid == userId &&
										request.resource.data.keys().hasOnly(['name','profileImageUrl']) &&
										request.resource.data.name is string &&
										(request.resource.data.profileImageUrl is string || !('profileImageUrl' in request.resource.data));

			// No deletes allowed of user profiles from client
			allow delete: if false;
		}

		// Custom display names: each user can set a custom name for their contacts
		// Path: /customNames/{userId}/contacts/{contactId}
		match /customNames/{userId}/contacts/{contactId} {
			// Allow reading your own custom names for contacts
			allow read: if request.auth != null && request.auth.uid == userId;

			// Allow creating/updating a custom name only if you're the owner and contactId is valid
			allow create, update: if request.auth != null && 
								  request.auth.uid == userId &&
								  isAllowedUser() &&
								  (contactId == "DrTZw7Kv5MeGpdVbiU4lp6Kk6nF3" || contactId == "EJTfm5BLcuQjgiCUMsYTVu0BJXS2") &&
								  request.resource.data.customName is string &&
								  request.resource.data.customName.size() > 0 &&
								  request.resource.data.customName.size() <= 50;

			// Allow deleting your own custom names
			allow delete: if request.auth != null && request.auth.uid == userId;
		}
	}
}
